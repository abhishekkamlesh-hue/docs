---
title: "Incoming Call Handler"
api: "POST /oriIncomingCallHandler"
description: "Handles incoming calls to purchased phone numbers and routes them using IVR logic"
---

## Overview

This webhook is triggered by Plivo/Oridial when someone calls your VoiceGenie phone number. It generates an XML response that controls call flow (IVR menu, routing to agents, voicemail, etc.).

---

##  Authentication

<ParamField header="X-Plivo-Signature-V2" type="string" required>
  HMAC SHA256 signature for webhook verification
</ParamField>

<ParamField header="X-Plivo-Signature-MA-V2" type="string">
  Multi-account signature (if using subaccounts)
</ParamField>

---

##  Request Body

<ParamField body="From" type="string" required>
  Caller's phone number in E.164 format
  ```
  +919876543210
  ```
</ParamField>

<ParamField body="To" type="string" required>
  Called number (your VoiceGenie number)
  ```
  +911234567890
  ```
</ParamField>

<ParamField body="CallUUID" type="string" required>
  Unique identifier for this call
  ```
  call-uuid-abc123
  ```
</ParamField>

<ParamField body="CallStatus" type="string" required>
  Current call status
  
  **Possible Values:**
  - `ringing` - Phone is ringing
  - `in-progress` - Call answered
  - `completed` - Call ended
</ParamField>

<ParamField body="Direction" type="string" required>
  Call direction: `inbound` or `outbound`
</ParamField>

<ParamField body="ForwardedFrom" type="string">
  If call was forwarded, original number
</ParamField>

<ParamField body="CallerName" type="string">
  Caller ID name (if available)
</ParamField>

<ParamField body="Duration" type="integer">
  Call duration in seconds (only in final status)
</ParamField>

<ParamField body="BillDuration" type="integer">
  Billable duration in seconds (rounded up)
</ParamField>

<ParamField body="HangupCause" type="string">
  Reason for call termination
  
  **Values:**
  - `NORMAL_CLEARING` - Normal call completion
  - `USER_BUSY` - Called party busy
  - `NO_ANSWER` - No answer
  - `CALL_REJECTED` - Call rejected
  - `INVALID_NUMBER` - Invalid phone number
</ParamField>

---

## Response Format

The endpoint must return XML (Plivo XML) with call instructions:

### Success Response (200 OK)

#### Basic IVR Menu:
```xml
<Response>
  <Speak>Welcome to VoiceGenie</Speak>
  <GetDigits 
    action="https://vb-seamless-dev-backend.oriserve.com/ivr-menu" 
    method="POST"
    numDigits="1"
    timeout="10"
    finishOnKey="#">
    <Speak>Press 1 for sales, press 2 for support, press 0 for operator</Speak>
  </GetDigits>
</Response>
```

#### Route to Agent:
```xml
<Response>
  <Speak>Please hold while we connect you to an available agent</Speak>
  <Dial>
    <Number>+919876543210</Number>
  </Dial>
</Response>
```

#### AI-Powered Response:
```xml
<Response>
  <Speak>Hi, I'm Alex, your AI assistant. How can I help you?</Speak>
  <GetInput 
    action="https://vb-seamless-dev-backend.oriserve.com/responseHook"
    method="POST"
    inputType="speech"
    timeout="10"
    maxSpeechTime="60"
    speechTimeout="5"
    interimSpeechResultsCallback="https://vb-seamless-dev-backend.oriserve.com/interim-results">
    <Speak>I'm listening...</Speak>
  </GetInput>
</Response>
```

#### Voicemail:
```xml
<Response>
  <Speak>All our agents are busy. Please leave a message after the beep.</Speak>
  <Record 
    action="https://vb-seamless-dev-backend.oriserve.com/voicemail"
    method="POST"
    maxLength="120"
    timeout="10"
    finishOnKey="#"
    recordSession="false"
    redirect="true"
    callbackUrl="https://vb-seamless-dev-backend.oriserve.com/recording-status"
    callbackMethod="POST" />
  <Speak>Thank you for your message. We'll call you back soon.</Speak>
</Response>
```

#### Call Queue with Music:
```xml
<Response>
  <Speak>All agents are currently assisting other customers</Speak>
  <Play loop="0">https://your-cdn.com/hold-music.mp3</Play>
  <Dial>
    <Queue>support-queue</Queue>
  </Dial>
</Response>
```

---

## Response XML Elements

### `<Speak>` - Text to Speech
```xml
<Speak voice="MAN" language="en-US">Hello world</Speak>
```

**Attributes:**
- `voice` - `MAN`, `WOMAN` (default: `WOMAN`)
- `language` - `en-US`, `en-GB`, `hi-IN`, etc.
- `loop` - Repeat count (default: 1)

### `<Play>` - Audio File
```xml
<Play loop="2">https://example.com/audio.mp3</Play>
```

**Supported Formats:** MP3, WAV

### `<GetDigits>` - DTMF Input
```xml
<GetDigits 
  action="/process-input"
  method="POST"
  numDigits="4"
  timeout="10"
  finishOnKey="#"
  retries="3">
  <Speak>Enter your 4-digit PIN</Speak>
</GetDigits>
```

### `<GetInput>` - Speech Recognition
```xml
<GetInput 
  action="/process-speech"
  inputType="speech"
  timeout="10"
  maxSpeechTime="60"
  speechTimeout="5">
  <Speak>How can I help you?</Speak>
</GetInput>
```

### `<Dial>` - Connect Call
```xml
<Dial 
  action="/call-completed"
  method="POST"
  timeout="30"
  callerId="+911234567890"
  timeLimit="3600"
  record="true"
  recordCallbackUrl="/recording-ready">
  <Number>+919876543210</Number>
</Dial>
```

### `<Record>` - Record Audio
```xml
<Record 
  action="/recording-completed"
  maxLength="120"
  timeout="10"
  finishOnKey="#"
  recordSession="false"
  callbackUrl="/recording-status"
  transcriptionType="auto"
  transcriptionUrl="/transcription-ready" />
```

### `<Hangup>` - End Call
```xml
<Hangup reason="rejected" />
```

---

## Example Use Cases

### 1. Business Hours Routing

```javascript
function generateIVR(timestamp) {
  const hour = new Date(timestamp).getHours();
  const isBusinessHours = hour >= 9 && hour < 18;
  
  if (isBusinessHours) {
    return `
      <Response>
        <Speak>Thank you for calling. Connecting you to an agent.</Speak>
        <Dial>
          <Queue>live-agents</Queue>
        </Dial>
      </Response>
    `;
  } else {
    return `
      <Response>
        <Speak>We're currently closed. Please leave a message.</Speak>
        <Record action="/voicemail" maxLength="120" />
      </Response>
    `;
  }
}
```

### 2. Geographic Routing

```javascript
function routeByLocation(from) {
  const areaCode = from.substring(1, 4); // Extract area code
  
  const routes = {
    '212': '+12125551001', // New York
    '310': '+13105552001', // Los Angeles
    '312': '+13125553001', // Chicago
  };
  
  const agentNumber = routes[areaCode] || '+18005550000'; // Default
  
  return `
    <Response>
      <Dial>${agentNumber}</Dial>
    </Response>
  `;
}
```

### 3. VIP Caller Detection

```javascript
async function handleIncomingCall(from) {
  const customer = await getCustomerByPhone(from);
  
  if (customer && customer.tier === 'VIP') {
    return `
      <Response>
        <Speak>Welcome back, ${customer.name}. Connecting you to priority support.</Speak>
        <Dial>
          <Queue priorityQueue="vip-support">vip-support</Queue>
        </Dial>
      </Response>
    `;
  }
  
  return `
    <Response>
      <Speak>Thank you for calling. Your estimated wait time is 5 minutes.</Speak>
      <Dial>
        <Queue>general-support</Queue>
      </Dial>
    </Response>
  `;
}
```

---

##  Response Time Requirements

<Warning>
  Your server must respond within **30 seconds** or Plivo will timeout the request and play a default error message to the caller.
</Warning>

**Best Practices:**
- Respond immediately with XML
- Process heavy logic asynchronously
- Cache frequently used data
- Use CDN for audio files

---

##  Webhook Flow Diagram

```
Caller dials number â†’ Plivo receives call â†’ POST to /oriIncomingCallHandler
                                                      â†“
                                         Your server returns XML
                                                      â†“
                                         Plivo executes XML instructions
                                                      â†“
                                         (IVR, Dial, Record, etc.)
                                                      â†“
                                         Further webhooks based on actions
```

---

## ðŸ§ª Testing

### cURL Example:
```bash
curl -X POST https://vb-seamless-dev-backend.oriserve.com/oriIncomingCallHandler \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -H "X-Plivo-Signature-V2: YOUR_SIGNATURE" \
  -d "From=+919876543210" \
  -d "To=+911234567890" \
  -d "CallUUID=test-call-123" \
  -d "CallStatus=ringing" \
  -d "Direction=inbound"
```

### Expected Response:
```xml
<Response>
  <Speak>Welcome to VoiceGenie</Speak>
  <GetDigits action="/ivr-menu" numDigits="1">
    <Speak>Press 1 for sales, 2 for support</Speak>
  </GetDigits>
</Response>
```

---

##  Error Handling

### Invalid XML Response:
If you return malformed XML, Plivo plays default error message.

### Server Timeout (> 30s):
```
"We're sorry, but we're having trouble connecting your call. Please try again later."
```

### No Response / HTTP Error:
Plivo retries 3 times with exponential backoff, then gives up.

---

## Rate Limits

| Plan | Concurrent Calls | Requests/sec |
|------|------------------|--------------|
| Free | 1 | 5 |
| Basic | 10 | 50 |
| Pro | 100 | 500 |
| Enterprise | Unlimited | Custom |

---

## Related Endpoints

- [Call Answer Status Hook](/api-reference/webhooks/call-answer-status) - Final call disposition
- [Recording Status](/api-reference/webhooks/recording-status) - Recording ready notification
- [AI Response Hook](/api-reference/webhooks/ai-response) - Process speech input

---

## Additional Resources

- [Plivo XML Reference](https://www.plivo.com/docs/voice/xml/)
- [WebSocket Events](/api-reference/websockets/real-time-events)
- [Campaign Management](/api-reference/campaign/start-campaign)
